<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Converte cadastro de produtos + relacionamentos</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            min-height: 100vh;
            background: #acb6e5;
            background: -webkit-linear-gradient(to right, #86fde8, #acb6e5);
            background: linear-gradient(to right, #86fde8, #acb6e5);
            padding: 20px;
            transition: background 0.5s ease;
        }

        body.skin-dark {
            background: #16222A;
            background: -webkit-linear-gradient(to right, #3A6073, #16222A);
            background: linear-gradient(to right, #3A6073, #16222A);
        }

        body.skin-green {
            background: #1D976C;
            background: -webkit-linear-gradient(to right, #93F9B9, #1D976C);
            background: linear-gradient(to right, #93F9B9, #1D976C);
        }

        body.skin-purple {
            background: #20002c;
            background: -webkit-linear-gradient(to right, #cbb4d4, #20002c);
            background: linear-gradient(to right, #cbb4d4, #20002c);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .skin-selector {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 20;
        }

        .skin-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .skin-toggle:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .skin-options {
            position: absolute;
            top: 50px;
            right: 0;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        .skin-options.active {
            display: flex;
        }

        .skin-options span {
            display: none; /* Hide the text label */
        }

        .skin-selector span {
            color: #fff;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .skin-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #fff;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .skin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .skin-btn.active {
            border-width: 4px;
            box-shadow: 0 0 15px rgba(255,255,255,0.8);
        }

        .skin-light {
            background: linear-gradient(135deg, #86fde8, #acb6e5);
        }

        .skin-dark-btn {
            background: linear-gradient(135deg, #3A6073, #16222A);
        }

        .skin-green-btn {
            background: linear-gradient(135deg, #93F9B9, #1D976C);
        }

        .skin-purple-btn {
            background: linear-gradient(135deg, #cbb4d4, #20002c);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-title {
            color: #fff;
            font-size: 1.5em;
            font-weight: 500;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            cursor: pointer; /* Make it clickable */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title-icon {
            transition: transform 0.3s ease;
        }

        .panel-title.collapsed .panel-title-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px; /* Large enough to hold content */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .upload-area.dragover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #fff;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .file-input {
            display: none;
        }

        .mapping-container {
            display: none;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .mapping-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .mapping-label {
            color: #fff;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
            font-size: 0.95em;
        }

        .mapping-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mapping-select:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-family: 'Ubuntu', sans-serif;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: #fff;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .btn-danger:hover {
            transform: scale(1.05);
        }

        .btn-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .data-container {
            display: none;
        }

        .utilities-panel {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .utility-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .utility-label {
            color: #fff;
            font-weight: 500;
        }

        .utility-select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 0.95em;
            cursor: pointer;
            min-width: 150px;
        }

        .utility-input {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 0.95em;
            flex: 1;
        }

        .table-wrapper {
            overflow: auto;
            max-height: 600px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.9);
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10;
        }

	        .data-table th {
	            padding: 12px 10px;
	            text-align: left;
	            color: #fff;
	            font-weight: 500;
	            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
	            white-space: nowrap;
	            min-width: 120px;
	            position: relative; /* Necess√°rio para o resizer */
	        }
	        
	        /* Ajuste para a coluna Descri√ß√£o (terceira coluna: checkbox, C√≥digo, Descri√ß√£o) */
	        .data-table th:nth-child(3), .data-table td:nth-child(3) {
	            min-width: 300px; /* Aumenta a largura m√≠nima para caber o conte√∫do */
	            white-space: normal; /* Permite quebra de linha */
	        }
	        
	        /* Estilo para o manipulador de redimensionamento */
	        .resizer {
	            position: absolute;
	            top: 0;
	            right: 0;
	            width: 5px;
	            cursor: col-resize;
	            user-select: none;
	            height: 100%;
	            z-index: 1;
	        }
	        
	        .resizer:hover {
	            background-color: rgba(255, 255, 255, 0.3);
	        }

        .data-table th input {
            width: 100%;
            padding: 6px;
            margin-top: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Ubuntu', sans-serif;
            font-size: 0.85em;
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background: #fff;
        }

        .data-table tr:nth-child(even) td {
            background: rgba(0, 0, 0, 0.02);
        }

        .data-table tr:hover td {
            background: rgba(102, 126, 234, 0.1);
        }

        .data-table td input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Ubuntu', sans-serif;
            font-size: 0.9em;
            background: transparent;
        }

        .data-table td input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .row-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .spinner {
            display: none;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            text-align: center;
            color: #fff;
            font-size: 1.1em;
            margin-top: 15px;
            display: none;
        }

        .hidden {
            display: none;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }

        .pagination-info {
            color: #fff;
            text-align: center;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .file-name {
            color: #fff;
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Conversor | Cadastro de Produtos + Relacionamentos</h1>
            <div class="skin-selector">
                <div class="skin-toggle" id="skinToggle" title="Selecionar Tema">üé®</div>
                <div class="skin-options" id="skinOptions">
                    <span>üé® Skins:</span>
                    <div class="skin-btn skin-light active" data-skin="light" title="Tema Claro"></div>
                    <div class="skin-btn skin-dark-btn" data-skin="dark" title="Tema Escuro"></div>
                    <div class="skin-btn skin-green-btn" data-skin="green" title="Tema Verde"></div>
                    <div class="skin-btn skin-purple-btn" data-skin="purple" title="Tema Roxo"></div>
                </div>
            </div>
        </div>

        <!-- Upload Panel -->
        <div class="glass-panel" id="uploadPanel">
            <h2 class="panel-title">1. Importar Arquivo Excel</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Clique ou arraste seu arquivo Excel aqui</div>
                <div class="upload-subtext">Suporta: .xlsx, .xls, .xlsm, .xlsb</div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.xlsm,.xlsb">
            </div>
            <div class="file-name" id="fileName"></div>
            <div class="spinner" id="loadSpinner"></div>
            <div class="spinner-text" id="loadSpinnerText">Carregando arquivo...</div>
        </div>

        <!-- Mapping Panel -->
        <div class="glass-panel mapping-container" id="mappingPanel">
            <h2 class="panel-title" id="mappingTitle">2. Mapeamento de Campos (De-Para) <span class="panel-title-icon">‚ñº</span></h2>
            <div class="collapsible-content collapsed" id="mappingContent">
                <div class="mapping-grid" id="mappingGrid"></div>
                <div class="spinner" id="mapSpinner"></div>
                <div class="spinner-text" id="mapSpinnerText">Processando mapeamento...</div>
                <div class="btn-container">
                    <button class="btn btn-primary" id="processMappingBtn">Processar De-Para</button>
                </div>
            </div>
        </div>

        <!-- Data Panel -->
        <div class="glass-panel data-container" id="dataPanel">
            <h2 class="panel-title">3. Dados</h2>
            
            <!-- Utilities -->
            <div class="utilities-panel">
                <div class="utility-group">
                    <span class="utility-label">Aplicar em:</span>
                    <select class="utility-select" id="bulkTargetSelect">
                        <option value="all">Todas</option>
                        <option value="empty">Vazias</option>
                        <option value="selected">Selecionadas</option>
                    </select>
                    <span class="utility-label">Campo:</span>
                    <select class="utility-select" id="bulkFieldSelect"></select>
                    <input type="text" class="utility-input" id="bulkValueInput" placeholder="Novo valor">
                    <button class="btn btn-primary" id="applyBulkBtn">Aplicar</button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="pagination-controls">
                <button class="btn btn-primary" id="prevPageBtn" disabled>&lt;&lt;</button>
                <div class="pagination-info" id="paginationInfo"></div>
                <button class="btn btn-primary" id="nextPageBtn" disabled>&gt;&gt;</button>
            </div>
            
            <div class="spinner" id="saveSpinner"></div>
            <div class="spinner-text" id="saveSpinnerText">Salvando arquivo...</div>
            
            <div class="btn-container">
                <button class="btn btn-success" id="saveBtn">üíæ Salvar TXT</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let excelData = [];
        let mappedData = [];
        let columnMapping = {};
        let currentPage = 1;
        const rowsPerPage = 20;
        let filteredData = []; // New variable to hold filtered data for pagination
        const targetFields = [
            'C√≥digo', 'Descri√ß√£o', 'Unidade', 'NCM', 'CEST',
            'Conta Estoque', 'Quantidade', 'Valor unit√°rio', 'Valor Total',
            'Icms Recuper√°vel', 'C√≥digo Interno Produto', 'CNPJ Fornecedor',
            'Codigo Produto Fornecedor'
        ];

        // Skin selector
        document.getElementById('skinToggle').addEventListener('click', function() {
            document.getElementById('skinOptions').classList.toggle('active');
        });

        document.querySelectorAll('.skin-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.skin-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const skin = this.dataset.skin;
                document.body.className = '';
                if (skin !== 'light') {
                    document.body.classList.add(`skin-${skin}`);
                }
                document.getElementById('skinOptions').classList.remove('active'); // Close after selection
            });
        });

        // Upload area
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            document.getElementById('fileName').textContent = `Arquivo: ${file.name}`;
            showSpinner('load');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    setTimeout(() => {
                        hideSpinner('load');
                        createMappingInterface();
                    }, 800);
                } catch (error) {
                    hideSpinner('load');
                    alert('Erro ao ler o arquivo: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function createMappingInterface() {
            if (excelData.length === 0) return;
            
            // Show the panel and expand the content
            document.getElementById('mappingPanel').style.display = 'block';
            document.getElementById('mappingContent').classList.remove('collapsed');
            document.getElementById('mappingTitle').classList.remove('collapsed');

            const headers = excelData[0];
            const mappingGrid = document.getElementById('mappingGrid');
            mappingGrid.innerHTML = '';
            
            targetFields.forEach(targetField => {
                const item = document.createElement('div');
                item.className = 'mapping-item';
                
                const label = document.createElement('label');
                label.className = 'mapping-label';
                label.textContent = targetField;
                
                const select = document.createElement('select');
                select.className = 'mapping-select';
                select.dataset.target = targetField;
                
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = '-- Selecione --';
                select.appendChild(emptyOption);
                
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `Coluna ${index + 1}`;
                    
                    // Auto-match similar names
                    if (header && header.toLowerCase().includes(targetField.toLowerCase().split(' ')[0])) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
                
                item.appendChild(label);
                item.appendChild(select);
                mappingGrid.appendChild(item);
            });
            
            document.getElementById('mappingPanel').style.display = 'block';
        }

        document.getElementById('processMappingBtn').addEventListener('click', processMapping);

        // Accordion logic for Mapping Panel
        document.getElementById('mappingTitle').addEventListener('click', function() {
            const content = document.getElementById('mappingContent');
            this.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        });

        function processMapping() {
            showSpinner('map');
            
            setTimeout(() => {
                columnMapping = {};
                document.querySelectorAll('.mapping-select').forEach(select => {
                    if (select.value !== '') {
                        columnMapping[select.dataset.target] = parseInt(select.value);
                    }
                });
                
            mappedData = [];
            for (let i = 1; i < excelData.length; i++) {
                const row = {};
                let hasValue = false; // Flag para verificar se a linha tem algum valor
                targetFields.forEach(field => {
                    if (columnMapping[field] !== undefined) {
                        const rawValue = excelData[i][columnMapping[field]] || '';
                        row[field] = rawValue;
                        // Verifica se o valor, ap√≥s ser convertido para string e ter espa√ßos removidos, n√£o est√° vazio
                        if (String(rawValue).trim() !== '') {
                            hasValue = true;
                        }
                    } else {
                        row[field] = '';
                    }
                });
                
                // Adiciona a linha apenas se ela tiver pelo menos um valor
                if (hasValue) {
                    mappedData.push(row);
                }
            }
                
                hideSpinner('map');
                createDataTable();
                document.getElementById('dataPanel').style.display = 'block';
            }, 1000);
        }

        function createDataTable() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
	            // Create header
	            let headerHTML = '<tr><th><input type="checkbox" id="selectAll" class="row-checkbox"></th>';
	            targetFields.forEach(field => {
	                headerHTML += `<th>${field}<br><input type="text" class="search-input" data-field="${field}" placeholder="Pesquisar..."><div class="resizer"></div></th>`;
	            });
	            headerHTML += '<th>A√ß√µes</th></tr>';
	            tableHead.innerHTML = headerHTML;
            
            // Populate bulk field select
            const bulkFieldSelect = document.getElementById('bulkFieldSelect');
            bulkFieldSelect.innerHTML = '';
            targetFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field;
                bulkFieldSelect.appendChild(option);
            });
            
	            // Reset pagination and render rows
	            currentPage = 1;
	            renderTableRows();
	            
	            // Colum Resizing Logic
	            const table = document.getElementById('dataTable');
	            const resizers = table.querySelectorAll('.resizer');
	            let th;
	            let startX;
	            let startWidth;
	
	            function mouseMove(e) {
	                const width = startWidth + (e.clientX - startX);
	                th.style.width = `${width}px`;
	                th.style.minWidth = `${width}px`;
	            }
	
	            function mouseUp() {
	                document.removeEventListener('mousemove', mouseMove);
	                document.removeEventListener('mouseup', mouseUp);
	                table.classList.remove('resizing');
	            }
	
	            function mouseDown(e) {
	                th = e.target.parentNode;
	                startX = e.clientX;
	                startWidth = th.offsetWidth;
	                table.classList.add('resizing');
	                document.addEventListener('mousemove', mouseMove);
	                document.addEventListener('mouseup', mouseUp);
	            }
	
	            resizers.forEach(resizer => {
	                resizer.addEventListener('mousedown', mouseDown);
	            });
	            
	            // Search functionality
            document.querySelectorAll('.search-input').forEach(input => {
                input.addEventListener('input', function() {
                    currentPage = 1; // Reset page on search
                    renderTableRows();
                });
            });
            
            // Select all
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.row-select').forEach(cb => {
                    cb.checked = this.checked;
                });
            });

	            // Pagination buttons
	document.getElementById('prevPageBtn').addEventListener('click', function() {
    // O c√°lculo de totalPages √© feito dentro de renderTableRows, mas precisamos dele aqui para a verifica√ß√£o
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    if (currentPage > 1) {
        currentPage--;
        renderTableRows();
    }
});

document.getElementById('nextPageBtn').addEventListener('click', function() {
    // Recalcula totalPages para garantir que a l√≥gica esteja atualizada
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderTableRows();
    }
});
        }

        function renderTableRows() {
            const tableBody = document.getElementById('tableBody');
            const searchFilters = {};
            
            document.querySelectorAll('.search-input').forEach(input => {
                if (input.value.trim()) {
                    searchFilters[input.dataset.field] = input.value.toLowerCase();
                }
            });
            
            // 1. Filter Data
            if (Object.keys(searchFilters).length === 0) {
                filteredData = mappedData;
            } else {
                filteredData = mappedData.filter(row => {
                    for (let field in searchFilters) {
                        const value = String(row[field] || '').toLowerCase();
                        if (!value.includes(searchFilters[field])) {
                            return false;
                        }
                    }
                    return true;
                });
            }

            // Debugging: Check if filteredData has enough rows for pagination
            // console.log(`Total rows: ${mappedData.length}, Filtered rows: ${filteredData.length}, Current Page: ${currentPage}`);
            
            // 2. Paginate Data
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            
            // Ensure current page is valid
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const displayData = filteredData.slice(start, end);
            
            // 3. Render Rows
            tableBody.innerHTML = '';
            
            displayData.forEach((row, index) => {
                // Calculate the original index in mappedData for editing/deleting
                const originalIndex = mappedData.findIndex(item => item === row);

                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" class="row-select row-checkbox" data-index="${originalIndex}"></td>`;
                
                targetFields.forEach(field => {
                    tr.innerHTML += `<td><input type="text" class="cell-input" data-index="${originalIndex}" data-field="${field}" value="${row[field] || ''}"></td>`;
                });
                
                tr.innerHTML += `<td><button class="btn btn-danger delete-btn" data-index="${originalIndex}">Excluir</button></td>`;
                tableBody.appendChild(tr);
            });
            
            // 4. Update Pagination Info and Controls
            document.getElementById('paginationInfo').textContent = 
                `P√°gina ${currentPage} de ${totalPages || 1} | Exibindo ${displayData.length} de ${filteredData.length} linhas (Total: ${mappedData.length})`;
            
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;

            // 5. Cell edit handlers
            document.querySelectorAll('.cell-input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    mappedData[index][field] = this.value;
                });
            });
            
            // 6. Delete handlers
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    if (confirm('Deseja realmente excluir esta linha?')) {
                        mappedData.splice(index, 1);
                        renderTableRows();
                    }
                });
            });
        }

        // Bulk edit
        document.getElementById('applyBulkBtn').addEventListener('click', function() {
            const target = document.getElementById('bulkTargetSelect').value;
            const field = document.getElementById('bulkFieldSelect').value;
            const value = document.getElementById('bulkValueInput').value;
            
            if (!value.trim()) {
                alert('Por favor, insira um valor para aplicar.');
                return;
            }
            
            if (target === 'all') {
                mappedData.forEach(row => row[field] = value);
            } else if (target === 'empty') {
                mappedData.forEach(row => {
                    if (!row[field] || row[field].trim() === '') {
                        row[field] = value;
                    }
                });
            } else if (target === 'selected') {
                document.querySelectorAll('.row-select:checked').forEach(cb => {
                    const index = parseInt(cb.dataset.index);
                    mappedData[index][field] = value;
                });
            }
            
            renderTableRows();
            document.getElementById('bulkValueInput').value = '';
        });

        // Save to TXT
        document.getElementById('saveBtn').addEventListener('click', function() {
            showSpinner('save');
            
            setTimeout(() => {
                let txtContent = ''; // Inicia vazio, sem cabe√ßalho
                
                mappedData.forEach(row => {
                    const numericFields = ['Quantidade', 'Valor unit√°rio', 'Valor Total', 'Icms Recuper√°vel'];
                    const values = targetFields.map(field => {
                        let value = String(row[field] || '');
                        
                        // 1. Tratamento de campos num√©ricos para padr√£o brasileiro
                        if (numericFields.includes(field)) {
                            // Remove todos os pontos (separador de milhar)
                            value = value.replace(/\./g, '');
                            // Substitui a v√≠rgula por ponto (se houver) para garantir que seja um n√∫mero v√°lido
                            value = value.replace(/,/g, '.');
                            
                            // Tenta converter para n√∫mero para garantir a precis√£o
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                // Formata o n√∫mero para string com v√≠rgula como separador decimal
                                // Isso √© feito convertendo para string com o locale 'pt-BR'
                                value = numValue.toLocaleString('pt-BR', { useGrouping: false, minimumFractionDigits: 2, maximumFractionDigits: 4 });
                            } else {
                                // Se n√£o for um n√∫mero, tenta reverter a substitui√ß√£o de v√≠rgula para ponto
                                value = String(row[field] || '');
                            }
                        }
                        
                        // 2. Remover quebras de linha para evitar quebra de registro
                        value = value.replace(/(\r\n|\n|\r)/gm, " ");
                        // 3. Remover o delimitador (;) para evitar quebra de coluna
                        value = value.replace(/;/g, ","); // Substitui ; por , para evitar problemas de delimitador
                        
                        return value;
                    });
                    txtContent += values.join(';') + '\n';
                });
                
                // Remove a √∫ltima quebra de linha para evitar linha vazia no final
                if (txtContent.length > 0) {
                    txtContent = txtContent.slice(0, -1);
                }
                
                // Create blob and download
                const blob = new Blob([txtContent], { type: 'text/plain;charset=windows-1252' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dados_exportados.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideSpinner('save');
                alert('Arquivo TXT salvo com sucesso!');
            }, 1000);
        });

        function showSpinner(type) {
            document.getElementById(`${type}Spinner`).style.display = 'block';
            document.getElementById(`${type}SpinnerText`).style.display = 'block';
        }

        function hideSpinner(type) {
            document.getElementById(`${type}Spinner`).style.display = 'none';
            document.getElementById(`${type}SpinnerText`).style.display = 'none';
        }
    </script>
</body>
</html>
